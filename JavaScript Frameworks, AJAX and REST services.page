---
categories: Classes JavaScript AJAX
toc: no
...

view this as a [slideshow](?export&format=Slidy)


# JavaScript frameworks

**[JavaScript]() frameworks** are libraries that extend [JavaScript]()
  functionalities.
  
**Why?**

> - Palliate **browser incompatibilities** (e.g. MSIE vs Firefox event handling);
> - Simplify **frequent tasks** (e.g. access elements via [CSS]() selectors, parse [JSON]() data);
> - **Enrich** [JavaScript]() **semantics** (e.g. add methods to [DOM]() prototypes);
> - Improve the **User Interface** (e.g. make animations, add smart controls);

# JQuery

<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

[JQuery]() is a very popular [JavaScript]() framework. It inherits
concepts from [Prototype](http://prototypejs.org/) and
[Script.aculo.us](http://script.aculo.us/).

**Main features:**

> - Cross-browser portability;
> - [CSS]()-like syntax to access [DOM]() entities;
> - Enriched [DOM]() elements;
> - [AJAX]() framework;
> - Very small core library (only 31k);
> - Modular UI components;
> - Plug-in architecture.


**Documentation resources:** <http://docs.jquery.com/>.


# JQuery CSS selectors

Using the classic [DOM]() Level 2, elements can be selected using one of

~~~ {.javascript}
document.getElementById('identifier');
document.getElementsByTag('p');
document.getElementsByClassName('classname');
~~~

**Defects:**

> - Results are DOM objects or DOM arrays, depending on the method;
> - No uniform calling interface, methods depend on browsers.

**[JQuery]()** has a unified interface to these methods, based on [CSS]() syntax

<style>
.alerted { background-color:yellow }
</style>

~~~ {.javascript}
jQuery('#identifier');
jQuery('p');
jQuery('.classname');
~~~

**Example:** <input type="button" onclick="jQuery('p, li').toggleClass('alerted');"
    value="Click to highlight <p>'s and <li>'s " />

~~~ {.javascript}
jQuery('p, li').toggleClass('alerted');
~~~


# JQuery tips

The global object `jQuery` has a much **shorter alias** `$`

~~~ {.javascript}
jQuery('p.header');
$('p.header');
~~~

**Ordinary [DOM]() objects** can be passed to the selector

~~~ {.javascript}
$(document.forms[0]).css('display', 'none');
~~~

Setter methods **return the same object** for chaining

~~~ {.javascript}
$('#menu').css('color', 'red').css('visibility', 'visible');
~~~


# JQuery UI

A rich library of **user interface components**

Here's just a small example: sortable elements (drag them)

<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>

<div id='sortable'/>

~~~ {.javascript}
$('#sortable').sortable();
~~~

~~~ {.html}
<div id='sortable'/>
  ...
</div>
~~~

~~~ {.html}
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
~~~

</div>

<script>
$('#sortable').sortable();
</script>


Find more UI controls on <http://jqueryui.com/>.



# Synchronous navigation

![Description of the Web 1.0 dataflow model, by Jesse J Garret](web1.0.png)

# Synchronous navigation example


<form method='GET' action='http://answers.yahoo.com/search/search_result'>
**Ask [Yahoo](http://answers.yahoo.com/) about:**
<input name='p' type='text' value='AJAX' />
<input type='submit' value='Ask' />
</form>

~~~ {.html}
<form method='GET' action='http://answers.yahoo.com/search/search_result'>
  <input name='p' type='text' value='AJAX' />
  <input type='submit' value='Ask' />
</form>
~~~

# Asynchronous navigation

![Description of the AJAX dataflow model, by Jesse J Garret](web2.0.png)

# Asynchronous navigation example

**Ask [Yahoo](http://answers.yahoo.com/) about:**
<input id='query' type='text' value='AJAX' />
<input id='yahoo' type='button' value='Ask' />

<div style='width:80%;min-height:4em;margin:auto;border: solid thin black' id='answers'></div>

<script type="text/javascript">
function yahoo() {
    $('#yahoo').add('#query').prop('disabled', true);
    $('#answers').fadeOut('slow', function() { $(this).html(''); });
    var query = $('#query').val();
    $.ajax({
        url : 'http://query.yahooapis.com/v1/public/yql',
        dataType : 'json',
        data : 'q=select%20*%20from%20answers.search%20where%20query%3D%22' +
                query +
                '%22&format=json&diagnostics=true&callback=',
        success : function(data) {
            if (data.query.results) {
                var qs = data.query.results.Question;
                var q = qs[Math.floor(Math.random() * qs.length)];
                $('#answers').html('<p><b>Question:</b> ' + q.Content + '</p>' +
                                   '<p><b>Best answer:</b> ' + q.ChosenAnswer + '</p>').fadeIn('slow');
            } else {
                $('#answers').html('<p>No results found.</p>').fadeIn('slow');
            }
        },
        complete : function() {
            $('#yahoo').add('#query').prop('disabled', false);
        }
    });
}

$('#query').keydown(function(e) { if (e.which == 13) yahoo(); });
$('#yahoo').click(yahoo);
</script>


# `XMLHttpRequest`

Introduced by Microsoft in MSIE 5, now a [W3C]() standard.

> - Sends **POST and GET** requests to a server;
> - **Does not block the browser** while it awaits for the response;
> - **Asynchronously executes callbacks** on the server response.

**Creation**

~~~ {.javascript}
xhr = new XMLHttpRequest();
~~~

**Registration of the callback**

~~~ {.javascript}
xhr.onreadystatechange = callback;
~~~

**Preparation and delivery of the request**

~~~ {.javascript}
xhr.open("GET", "http://example.com/api/json/query?car=peugeot&color=bleu");
xhr.send(null);
~~~


# Reacting to the response

The callback function is called many times with a different `readyState` status:

~~~ {.javascript}
function callback() {
    if (xhr.readyState == 4) {
        console.log(xhr.responseText);
    }
}
~~~

> - **`readyState == 0`** before `open()` has been called;
> - **`readyState == 1`** before the request is sent;
> - **`readyState == 2`** after the request has been sent and the server has responded with the status code and the [HTTP]() headers;
> - **`readyState == 3`** while the browser is downloading the body of the response, eventually more than once;
> - **`readyState == 4`** when the download is complete.


# JQuery AJAX interface

In practice, `XMLHttpRequest` has many problems

> - It isn't compatible among browsers;
> - The interface is awkward;
> - It lacks a lot of useful features, such as [JSON]() parsing.

Use [JavaScript]() frameworks instead. Here's [JQuery]()'s interface.

~~~ {.javascript}
$.ajax({
    url      :  'http://example.com/api/json/query',
    type     :  'GET',
    dataType :  'json',
    data     :  'car=peugeot&color=bleu',
    success  :  callback,
});
~~~

> - The request is created and sent at once;
> - Automatic [JSON]() / [XML]() / [JavaScript]() parsing;
> - The callback is bound to the scope of the AJAX object.


# Digging inside the example

~~~ {.javascript}
function yahoo() {
    $('#yahoo').add('#query').prop('disabled', true);

    $.ajax({
        url : 'http://query.yahooapis.com/v1/public/yql',
        dataType : 'json',
        data : 'q=select%20*%20from%20answers.search%20where%20query%3D%22' +
                query +
                '%22&format=json&diagnostics=true&callback=',
        success : function(data) {
            var q = data.query.results.Question[0];
            $('#answers').html('<p><b>Question:</b> ' + q.Content + '</p>' +
                               '<p><b>Best answer:</b> ' + q.ChosenAnswer + '</p>');
        },
        complete : function() {
            $('#yahoo').add('#query').prop('disabled', false);
        }
    });
}

$('#query').keydown(function(e) { if (e.which == 13) yahoo(); });
$('#yahoo').click(yahoo);
~~~

> 0. We disable controls, to avoid sending multiple request;
> 1. We connect to Yahoo API <http://query.yahooapis.com/v1/public/yql>;
> 2. We expect a [JSON]() result, it will be automatically parsed;
> 3. We use Yahoo's YQL language to perform the query (see <http://developer.yahoo.com/yql/console/>);
> 4. We extract the first result from the [JSON]() answer and put it into the page;
> 5. Finally, we activate the controls again.



# What formats for an AJAX request?

[AJAX]() stands for Asynchronous [JavaScript]() and [XML](). But each
component is optional, especially [XML]()!

## Text or Nothing

For simple actions such as

> - Autosaves (mail, documents, etc.)
> - Progress

~~~
POST /api/save HTTP/1.1
Host: mail.google.com
...

Dear Sir,

It is my ple
~~~

~~~
HTTP/1.1 200 OK
Content-Type: text/plain
...

23
~~~

---------------

## XHTML

For direct inclusion of [HTML]() fragments (e.g. blog posts, comments, ...)

~~~
GET /?post=23389 HTTP/1.1
Host: www.wordpress.com
...
~~~

~~~
HTTP/1.1 200 OK
Content-Type: text/html
...

<article class='post' id='post23389'>
<p>I've always thought...
~~~

Example of inclusion in the document:

~~~ {.javascript}
$.ajax({ success : function(data) {
    $('#main').append(data);
}});
~~~

**Problem:** Breaks the separation between **data**, **presentation**
  and **logic** (MVC : Model View Control).


---------------

## XML

For rich structured data (e.g. database queries, geodata, ...)

~~~
GET /v1/public/yql?q=SELECT * FROM geo.places WHERE text "Paris" HTTP/1.1
Host: query.yahooapis.com
...
~~~

(The request has been slightly modified to make it easier to read)

~~~ {.xml}
HTTP/1.1 200 OK
Content-Type: application/xml
...

<?xml version="1.0" encoding="UTF-8"?>
<query xmlns:yahoo="http://www.yahooapis.com/v1/base.rng"
    yahoo:count="10" yahoo:created="2012-03-14T04:38:52Z" yahoo:lang="en-US">
    ...
    <results>
        <place xmlns="http://where.yahooapis.com/v1/schema.rng"
            xml:lang="en-US" yahoo:uri="http://where.yahooapis.com/v1/place/615702">
            <woeid>615702</woeid>
            <placeTypeName code="7">Town</placeTypeName>
            <name>Paris</name>
            <country code="FR" type="Country">France</country>
            <admin1 code="" type="Region">Ile-de-France</admin1>
            <admin2 code="FR-75" type="Department">Paris</admin2>
            ...
~~~

---------------

## XML

**Parsing:**

> - **XPath**: Query language to select nodes in an [XML]() document;
> - **XSLT** (Extensible Stylesheet Language Transformations):
    transformations of [XML]() documents.
    
**Advantages:**

> - Powerful, robust;
> - Supported by many web services.

**Disadvantages:**

> - Verbose, relatively slow;
> - Non compliant implementations;
> - Huge specification with risks of security holes.

---------------

## Javascript

For dynamic execution of logic.

~~~
GET /api/car?user=toto HTTP/1.1
Host: www.example.com
...
~~~

~~~
HTTP/1.1 200 OK
Content-Type: application/javascript
...

{ car   : 'peugeot',
  color : 'blue'    }
~~~

Example of inclusion in the document:

~~~ {.javascript}
xhr.onreadystatechange = function() {
    var res = eval(xhr.responseText);
    ...
}
~~~

**Serious problems:** 

> - Breaks the MVC paradigm;
> - High risk of [XSS]() vulnerabilities;


---------------

## JSON

[JSON]() is a *lightweight* subset of [JavaScript]() datatypes
(**numbers**, **strings**, **arrays** and **objects**)

~~~
GET /api/car?user=toto HTTP/1.1
Host: www.example.com
...
~~~

~~~
HTTP/1.1 200 OK
Content-Type: application/json
...

{ "car"   : "peugeot",
  "color" : "blue"    }
~~~

**Advantages:**

> - Much more compact than [XML](), easy and fast to parse;
> - Supported by most browsers and [JavaScript]() frameworks;
> - Can be evaluated as [JavaScript]() by `eval` (but don't do it!).


**Disadvantages:**

> - Less powerful than [XML]();
> - Can lead to [XSS]() when evaluated as [JavaScript]().


# REST

**REST** (Representation State Transfer) is a paradigm for distributed applications

> - **Client-Server** (no peer-to-peer);
> - **Stateless** (unlike CORBA, etc.);
> - **Cacheable**;
> - **Layered** (i.e., it is compatible with the use of **proxies**);
> - **Uniform Interface** (e.g. GET, POST, PUT and DELETE verbs).

**Exemples:**

> - [HTTP]() (in practice, a **RESTful service** is one that works like [HTTP]());
> - ATOM feeds.

**Counter-example:** SOAP.

**Advantages:** Simplicity, Scalability.


# REST APIs

After a long period of predominance of SOAP interfaces, most web
services are now migrating to REST APIs.

> - **Google APIs**: <http://code.google.com/more/>;
> - **Open Street Maps**: <http://wiki.openstreetmap.org/wiki/API> (geodata, maps) ;
> - **Amazon**: <http://aws.amazon.com/>;
> - **The Weather Channel**: <http://www.weather.com/services/xmloap.html>;
> - **Facebook**: <http://developers.facebook.com> (authentication, social graph);
> - **Yahoo**: <http://developer.yahoo.com/>;
> - ...

Most of these APIs offer an [XML]() and a [JSON]() interface.

Check out the [Yahoo YQL Console](http://developer.yahoo.com/yql/console/)!


# Announcements

## Next week

> - No tutorials next Tuesday and Wednesday;
> - There will be class as usual Wednesday 21 at 3pm.

## The project

> - Choose your partner;
> - Choose your subject;
> - Send me an e-mail.
> - Work on it and discuss your problems with me on March 27/28.
